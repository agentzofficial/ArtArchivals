<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no">
  <title>agent z Art Archivals</title>
  <link rel="stylesheet" href="style.css">

  <link rel="icon" type="image/png" sizes="16x16" href="serverImages/fovicon-16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="serverImages/fovicon-32.png">
  <link rel="shortcut icon" href="serverImages/fovicon.ico">
</head>
<body>
  <header class="site-nav">
    <nav>
      <ul>
        <li><a href="index.html" class="active">Gallery</a></li>
        <li><span class="separator">|</span></li>
        <li><a href="contact.html">Contact</a></li>
        <li><span class="separator">|</span></li>
        <li><a href="policies.html">Usage Policies</a></li>
        <li><span class="separator">|</span></li>
        <li class="theme-selector">
          <select id="theme-select" aria-label="Choose theme">
            <option value="agentz">agent z Theme</option>
            <option value="dark">Basic Black</option>
            <option value="light">Basic White</option>
          </select>
        </li>
      </ul>
    </nav>
  </header>
  
  <img id="fixed-bg" alt="Background" />
  <div class="logo-container">
    <img src="serverImages/logo.png" alt="Art Archives Logo" id="logo">
  </div>
  <div id="filter-bar"></div>
  <div id="year-nav" class="year-nav"></div>
  <div class="gallery" id="gallery"></div>
  <div id="pagination-controls" class="pagination-controls"></div>

  <div id="modal" class="modal">
    <div class="modal-frame">
      <span class="close">&times;</span>
      <div class="modal-content">
        <h2 id="modal-title" class="modal-title"></h2>
        <div class="image-wrapper">
          <img id="modal-img" src="" alt="" />
        </div>
        <div class="modal-meta">
          <div class="variant-thumbs"></div>
          <div class="modal-date" id="modal-date"></div>
          <div class="modal-icons"></div>
        </div>
      </div>
  
      <div class="modal-description-bar">
        <p id="modal-description"></p>
      </div>
  
      <p class="loading-hint">Images may take some time to load.</p>
      <p class="navigation-hint">Use ← and → arrow keys to navigate.</p>
    </div>
  </div>

  <div id="year-nav-bottom" class="year-nav"></div>
  <div
    id="trivia-container"
    style="
      tet-align: center;
      margin: -64p auto 4; 
      padding: 0;
      display: inline-block;
    "
  >
    <img
      id="trivia-bo"
      src="serverImages/trivia-box.webp"
      alt="Trivia Box"
      style="display: block; margin: 0 auto;"
    />
    <div
      id="trivia-content"
      style="margin: 6px 0 2px;"
    >
      Loading trivia...
    </div>
  
    <div
      id="yeah-container"
      style="margin: 8px 0 0;
    "
    >
      <img
        id="yeah-button"
        src="serverImages/yeah-button.webp"
        alt="Yeah!"
        style="cursor: pointer; display: block; margin: 0 auto;"
      />
    </div>
  </div>
  
  <div
    id="trivia-time"
    style="
      text-align: center;
      margin: 6px auto 30px;
      font-size: 0.9em;
      opacity: 0.6;
      width: fit-content;
    "
  ></div>

  <script>
    let currentIndex = 0,
        artData      = [],
        includeTags  = new Set(),
        excludeTags  = new Set(),
        modalLoadVersion = 0,
        filteredIndices = [],
        currentPage    = 1,
        itemsPerPage   = 30;
  
    const TAG_ORDER = [
      "Renders", "Drawings", "Screenshots",
      "Thumbnails", "Sneak Peaks", "Specials", "Branding"
    ];
  
    function matchesFilter(tags = []) {
      for (let t of excludeTags) if (tags.includes(t)) return false;
      if (includeTags.size) {
        for (let t of includeTags) if (tags.includes(t)) return true;
        return false;
      }
      return true;
    }
  
    const filterBar = document.getElementById('filter-bar');
    const gallery   = document.getElementById('gallery');
    const modal     = document.getElementById('modal');
    const modalImg  = document.getElementById('modal-img');
    const modalTitle= document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-description');
    const modalDate = document.getElementById('modal-date');
    const iconsEl   = document.querySelector('.modal-icons');
    const navHint   = document.querySelector('.navigation-hint');
    const loadHint  = document.querySelector('.loading-hint');
    const closeBtn  = document.querySelector('.close');

  
    let itemNodes = [];
    let selectedYear = 'all';
    function buildGallery() {
      gallery.innerHTML = '';
      itemNodes = [];
    
      const start   = (currentPage - 1) * itemsPerPage;
      const end     = start + itemsPerPage;
      const visible = filteredIndices.slice(start, end);

      const frag = document.createDocumentFragment();
    
      for (let idx of visible) {
        const item        = artData[idx];
        const thumb       = (item.variants && item.variants[0]) || item.filename;
        const hasVariants = item.variants && item.variants.length > 1;
    
        const div = document.createElement('div');
        div.className = 'art-item';
        div.innerHTML = `
          <div class="image-container">
            <img class="thumb" loading="lazy"
                 src="imagesPreview/${thumb.replace(/\.[^/.]+$/, '.webp')}"
                 alt="${item.title.replace(/"/g, '&quot;')}"
                 style="object-position:${item.position || 'center'};">
            ${hasVariants
              ? `<img class="variant-icon"
                      src="serverImages/variant-icon.png"
                      alt="Has Variants">`
              : ''}
            <div class="overlay">
              <h2>${item.title.replace(/</g, '&lt;')}</h2>
              <p class="date">${item.date || ''}</p>
            </div>
          </div>`;
    
        div.addEventListener('click', () => showModal(idx, 0));
        frag.appendChild(div);
        itemNodes.push(div);
      }

      gallery.appendChild(frag);
    }

    function updatePaginationControls() {
      const totalPages = Math.ceil(filteredIndices.length / itemsPerPage);
      const container  = document.getElementById('pagination-controls');
      container.innerHTML = '';
    
      if (totalPages <= 1) return;

      const prev = document.createElement('button');
      prev.textContent = '‹ Prev';
      prev.disabled    = currentPage === 1;
      prev.onclick     = () => {
        currentPage--;
        renderGallery();
      };
      container.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => {
          currentPage = i;
          renderGallery();
        };
        container.appendChild(btn);
      }
 
      const next = document.createElement('button');
      next.textContent = 'Next ›';
      next.disabled    = currentPage === totalPages;
      next.onclick     = () => {
        currentPage++;
        renderGallery();
      };
      container.appendChild(next);
    }
  
    let pendingRender = false;
    function renderGallery() {
      if (pendingRender) return;
      pendingRender = true;
    
      requestAnimationFrame(() => {
        filteredIndices = [];
        artData.forEach((item, idx) => {
          const year = new Date(item.date).getFullYear().toString();
          const yearMatch = (selectedYear === 'all' || year === selectedYear);
          const tagMatch = matchesFilter(item.tags || []);
          if (yearMatch && tagMatch) filteredIndices.push(idx);
        });
    
        buildGallery();
        updatePaginationControls();
    
        pendingRender = false;
      });
    }
      
    function showModal(index, variantIndex = 0) {
      const item     = artData[index];
      if (!item) return;
      currentIndex   = filteredIndices.indexOf(index);
      const variants = item.variants || [item.filename];
      const currentVersion = ++modalLoadVersion;
    
      const previewSrc = `imagesPreview/${variants[variantIndex].replace(/\.[^/.]+$/, '.webp')}`;
      modalImg.src     = previewSrc;
      modalImg.alt     = item.title;
    
      const vbThumbs = document.querySelector('.variant-thumbs');
      vbThumbs.innerHTML = '';
      if (variants.length > 1) {
        vbThumbs.style.visibility = 'visible';
        vbThumbs.style.pointerEvents = '';
        variants.forEach((fn, i) => {
          const thumb = document.createElement('img');
          thumb.src         = `imagesPreview/${fn.replace(/\.[^/.]+$/, '.webp')}`;
          thumb.className   = i === variantIndex ? 'active' : '';
          thumb.addEventListener('click', e => {
            e.stopPropagation();
            showModal(index, i);
          });
          vbThumbs.appendChild(thumb);
        });
      } else {
        vbThumbs.style.visibility     = 'hidden';
        vbThumbs.style.pointerEvents  = 'none';
      }
    
      modalTitle.textContent = item.title;
      modalDesc.textContent  = item.description || '';
      modalDate.textContent  = item.date        || '';
    
      const actualSrc = `images/${variants[variantIndex].replace(/\.[^/.]+$/, '.png')}`;
      document.querySelector('.image-wrapper')
              .style.setProperty('--modal-blur-src', `url("${actualSrc}")`);
    
      const actualImg = new Image();
      actualImg.onload = () => {
        if (currentVersion === modalLoadVersion) {
          modalImg.src = actualSrc;
        }
      };
      actualImg.src = actualSrc;
    
      [ -2, -1, 1, 2 ].forEach(offset => {
        const ni = index + offset;
        if (ni >= 0 && ni < artData.length) {
          const fn = (artData[ni].variants?.[0] || artData[ni].filename)
                       .replace(/\.[^/.]+$/, '.png');
          new Image().src = `images/${fn}`;
        }
      });
    
      iconsEl.innerHTML = '';
      if (item.youtube) iconsEl.innerHTML +=
        `<a href="${item.youtube}" target="_blank" class="source-icon">
           <img src="serverImages/youtube-icon.png" alt="YouTube">
         </a>`;
      if (item.twitter) iconsEl.innerHTML +=
        `<a href="${item.twitter}" target="_blank" class="source-icon">
           <img src="serverImages/twitter-icon.png" alt="Twitter">
         </a>`;
      if (item.bluesky) iconsEl.innerHTML +=
        `<a href="${item.bluesky}" target="_blank" class="source-icon">
           <img src="serverImages/bluesky-icon.png" alt="Bluesky">
         </a>`;

      modal.style.display    = 'flex';
      loadHint.style.display = 'block';
      navHint.style.display  = 'block';
    }
  
    closeBtn.onclick = () => {
      modal.style.display    = 'none';
      loadHint.style.display = 'none';
      navHint.style.display  = 'none';
    };
    window.onclick   = e => { if (e.target === modal) closeBtn.onclick(); };
    document.addEventListener('keydown', e => {
      if (modal.style.display === 'flex') {
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
          showModal(filteredIndices[currentIndex - 1], 0);
        }
        if (e.key === 'ArrowRight' && currentIndex < filteredIndices.length - 1) {
          showModal(filteredIndices[currentIndex + 1], 0);
        }
        if (e.key === 'Escape') {
          closeBtn.onclick();
        }
      }
    });
  
    TAG_ORDER.forEach((tag, i) => {
      const btn = document.createElement('button');
      btn.textContent   = tag;
      btn.className     = 'filter-btn neutral';
      btn.dataset.tag   = tag;
      btn.addEventListener('click', () => {
        if (btn.classList.contains('neutral')) {
          btn.className = 'filter-btn include';
          includeTags.add(tag);
        }
        else if (btn.classList.contains('include')) {
          btn.className = 'filter-btn exclude';
          includeTags.delete(tag);
          excludeTags.add(tag);
        }
        else {
          btn.className = 'filter-btn neutral';
          excludeTags.delete(tag);
        }
        currentPage = 1;
        renderGallery();
      });
      filterBar.appendChild(btn);
      if (i === 2) {
        const divider = document.createElement('span');
        divider.textContent = '|';
        divider.className   = 'divider';
        filterBar.appendChild(divider);
      }
    });

    function buildYearNav() {
      const yearsSet = new Set(
        artData.map(item => new Date(item.date).getFullYear().toString())
      );
      const years = Array.from(yearsSet)
        .sort((a, b) => parseInt(b) - parseInt(a));
    
      years.unshift('all');
    
      const html = years.map(y =>
        `<button data-year="${y}" class="${y === selectedYear ? 'selected' : ''}">`
          + (y === 'all' ? 'All' : y) +
        `</button>`
      ).join('');
    
      document.getElementById('year-nav').innerHTML = html;
      document.getElementById('year-nav-bottom').innerHTML = html;
    
      document.querySelectorAll('.year-nav button').forEach(btn => {
        btn.onclick = () => {
          selectedYear = btn.dataset.year;
          currentPage = 1;
          buildYearNav();
          renderGallery();
        };
      });
    }
    
    function schedulePreload() {
      const preloadList = itemNodes
        .map((node, idx) => matchesFilter(artData[idx].tags || []) ? artData[idx] : null)
        .filter(Boolean);
    
      let index = 0;
      const preloadNext = () => {
        if (index >= preloadList.length) return;
        const item = preloadList[index++];
        const filename = item.variants?.[0] || item.filename;
        const img = new Image();
        img.onload = preloadNext;
        img.src = `images/${filename.replace(/\.[^/.]+$/, '.png')}`;
      };
      preloadNext();
    }

    function loadAllYears() {
      const years = [2025, 2024, 2023];
      return Promise.all(years.map(y => fetch(`data/${y}.json`).then(r => r.json())))
        .then(arrays => arrays.flat());
    }

    window.addEventListener('DOMContentLoaded', () => {
      selectedYear = 'all';
      loadAllYears()
        .then(data => {
          artData = data;
          buildGallery();
          buildYearNav();
          renderGallery();
        })
        .catch(err => console.error(err));
    });
  </script>
  <script>
    async function loadTrivia() {
      try {
        const resp  = await fetch('trivia.json'),
              data  = await resp.json(),
              today = new Date().toISOString().slice(0,10),
              entry = data.find(e => e.date === today),
              el    = document.getElementById('trivia-content');
        el.textContent = entry
          ? entry.trivia
          : "If you see this, I forgor 💀";
      } catch {
        document.getElementById('trivia-content').textContent = "Couldn’t load trivia.";
      }
    }
    function clampTriviaFont() {
      const el = document.getElementById('trivia-content');
      const style = window.getComputedStyle(el);
      const lineHeight = parseFloat(style.lineHeight);
      const maxHeight = lineHeight * 3;
      let fontSize = parseFloat(style.fontSize);
      while (el.scrollHeight > maxHeight && fontSize > 10) {
        fontSize -= 1;  
        el.style.fontSize = fontSize + 'px';
      }
    }
    window.addEventListener('DOMContentLoaded', async () => {
      await loadTrivia();
      clampTriviaFont();
      const bjMidnightUTC = new Date();
      bjMidnightUTC.setUTCHours(16, 0, 0, 0);
    
      const localTimeString = bjMidnightUTC.toLocaleTimeString(undefined, {
        hour:   '2-digit',
        minute: '2-digit',
        timeZoneName: 'short'
      });
    
      document.getElementById("trivia-time").textContent =
        `Trivia updates daily at ${localTimeString} your time.`;
    });
    window.addEventListener('resize', clampTriviaFont);
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      updateDoc, increment
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyApMY8GjkeZ7uFq5LUvOpkGkglkfZGIOp4",
      authDomain: "agentz-art-archivals.firebaseapp.com",
      projectId: "agentz-art-archivals",
      storageBucket: "agentz-art-archivals.firebasestorage.app",
      messagingSenderId: "120997134026",
      appId: "1:120997134026:web:6582de3d37606690f43e33",
      measurementId: "G-Y2EXMPLF4F"
    };
  
    const app    = initializeApp(firebaseConfig);
    const db     = getFirestore(app);
  
    const today      = new Date().toISOString().slice(0,10);
    const counterRef = doc(db, "counters", `yeah-${today}`);
  
    const button = document.getElementById("yeah-button");
    const CLICKED_KEY = `yeahClicked-${today}`;
  
    if (localStorage.getItem(CLICKED_KEY)) {
      button.style.opacity       = 0.5;
      button.style.pointerEvents = "none";
    }
  
    button.addEventListener("click", async () => {
      button.disabled = true;
      button.style.opacity       = 0.5;
      button.style.pointerEvents = "none";
    
      localStorage.setItem(CLICKED_KEY, "1");
    
      try {
        await updateDoc(counterRef, { count: increment(1) });
      } catch (e) {
        if (e.code === 'not-found') {
          await setDoc(counterRef, { count: 1 });
        } else {
          console.error("Unexpected Firestore error:", e);
          button.disabled = false;
          button.style.opacity = 1;
          button.style.pointerEvents = "";
          return;
        }
      }
    });
  </script>
  <script>
    const THEME_KEY = 'preferredTheme';
    const select    = document.getElementById('theme-select');
    const bodyEl    = document.body;

    if (!document.getElementById('fixed-bg')) {
      const agentzOption = select.querySelector('option[value="agentz"]');
      agentzOption.disabled = true;
    }
  
    function applyTheme(theme) {
      bodyEl.classList.remove('theme-dark','theme-light','theme-agentz');
      bodyEl.classList.add('theme-' + theme);
      localStorage.setItem(THEME_KEY, theme);
      
      const bgImg = document.getElementById('fixed-bg');
      if (!bgImg) return;
  
      if (theme === 'agentz') {
        bgImg.style.display = '';
        const maxBg = 9;
        const n     = Math.floor(Math.random() * maxBg) + 1;
        bgImg.src         = `backgrounds/bg${n}.webp`;
      } else {
        bgImg.style.display = 'none';
      }
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem(THEME_KEY) || 'agentz';
      select.value = saved;
      applyTheme(saved);
  
      select.addEventListener('change', () => {
        applyTheme(select.value);
      });
    });
  </script>
</body>
</html>
